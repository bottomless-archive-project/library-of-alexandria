<html lang="en">
<head>
    <title>Bottomless Archive Project - Library of Alexandria</title>

    <link rel="icon" href="./images/sphinx.svg" type="image/svg+xml">

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- AngularJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.7.9/angular.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/1.0.26/angular-ui-router.js"></script>

    <!-- Bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css"/>

    <!-- Custom -->
    <link rel="stylesheet" href="./style/index.css"/>
    <link rel="stylesheet" href="./style/spinner.css"/>

    <script>
        angular.module('library-of-alexandria', ['ui.router'])
            .config(['$stateProvider', '$urlRouterProvider', '$httpProvider', '$sceProvider', function ($stateProvider, $urlRouterProvider, $httpProvider, $sceProvider) {
                $sceProvider.enabled(false);

                $httpProvider.defaults.withCredentials = true;

                $urlRouterProvider.otherwise('/');

                $stateProvider
                    .state({
                        name: 'home',
                        url: '/',
                        templateUrl: './home/home.html'
                    })
                    .state({
                        name: 'dashboard',
                        url: '/dashboard',
                        templateUrl: './dashboard/dashboard.html'
                    })
                    .state({
                        name: 'search',
                        url: '/search',
                        templateUrl: './search/search.html',
                        resolve: {
                            documentStatistics: ['$http', function ($http) {
                                return $http.get('/statistics')
                                    .then(function (response) {
                                        return response.data;
                                    });
                            }]
                        },
                        controller: function ($scope, $http, documentStatistics) {
                            $scope.statistics = documentStatistics;
                            $scope.searchText = '';
                            $scope.hits = [];
                            $scope.openPdfs = [];
                            $scope.page = 0;
                            $scope.totalPages = 0;
                            $scope.language = undefined;
                            $scope.documentLength = undefined;
                            $scope.fileTypes = {};

                            $scope.loading = false;

                            $scope.setDocumentLength = function (documentLength) {
                                $scope.documentLength = documentLength;

                                $scope.refreshHits();
                            };

                            $scope.setLanguage = function (language) {
                                $scope.language = language;

                                $scope.refreshHits();
                            };

                            $scope.searchTextChanged = function () {
                                $scope.page = 0;
                                $scope.totalPages = 0;

                                $scope.refreshHits();
                            };

                            $scope.jumpToPage = function (page) {
                                $scope.page = page;

                                $scope.refreshHits();
                            };

                            $scope.getPageCountToDisplayOnLeftSide = function () {
                                if ($scope.page - 5 > 0) {
                                    return [$scope.page - 5, $scope.page - 4, $scope.page - 3, $scope.page - 2, $scope.page - 1];
                                } else {
                                    var result = [];
                                    for (var i = 0; i < $scope.page; i++) {
                                        result.push($scope.page - i - 1);
                                    }
                                    result.reverse();

                                    return result;
                                }
                            };

                            $scope.getPageCountToDisplayOnRightSide = function () {
                                if ($scope.totalPages > $scope.page + 5) {
                                    return [$scope.page + 1, $scope.page + 2, $scope.page + 3, $scope.page + 4, $scope.page + 5];
                                } else {
                                    var result = [];
                                    for (var i = 0; i < $scope.totalPages - $scope.page - 1; i++) {
                                        result.push($scope.page + i + 1);
                                    }

                                    return result;
                                }
                            };

                            $scope.refreshHits = function () {
                                if ($scope.searchText === "") {
                                    $scope.hits = [];
                                    $scope.hitCount = 0;
                                    $scope.totalPages = 0;

                                    return;
                                }

                                $scope.loading = true;

                                var pageNumber = $scope.page * 10;
                                var exactMatch = $scope.searchText.startsWith("\"") && $scope.searchText.endsWith("\"");

                                var urlBase = '/document/find-by/keyword/' + $scope.searchText + '/?pageNumber='
                                    + pageNumber;

                                if (exactMatch) {
                                    urlBase += '&exactMatch=' + exactMatch;
                                }

                                if ($scope.language !== undefined) {
                                    urlBase += '&language=' + $scope.language[0];
                                }

                                if ($scope.documentLength !== undefined) {
                                    urlBase += '&documentLength=' + $scope.documentLength[0];
                                }

                                var types = Object.keys($scope.fileTypes).filter(value => $scope.fileTypes[value]);
                                if (types.length > 0) {
                                    urlBase += '&documentTypes=' + types.join();
                                }

                                $http.get(urlBase)
                                    .then(function (response) {
                                        $scope.hits = response.data.searchHits;
                                        $scope.hitCount = response.data.totalHitCount;
                                        $scope.totalPages = Math.ceil(response.data.totalHitCount / 10);
                                        $scope.loading = false;
                                    });
                            };

                            $scope.openPdf = function (pdfId) {
                                $scope.openPdfs[pdfId] = !$scope.openPdfs[pdfId];
                            };

                            $scope.documentLengths = [
                                ['SHORT_STORY', 'Short story (1 - 10 pages)'],
                                ['NOVELETTE', 'Novelette (11 - 50 pages)'],
                                ['NOVELLA', 'Novella (51 - 150 pages)'],
                                ['NOVEL', 'Novel (150+ pages)']
                            ];

                            $scope.languages = [
                                ['be', 'Belarusian', true],
                                ['ca', 'Catalan', true],
                                ['da', 'Danish', true],
                                ['de', 'German', true],
                                ['eo', 'Esperanto', false],
                                ['et', 'Estonian', true],
                                ['el', 'Greek', true],
                                ['en', 'English', true],
                                ['es', 'Spanish', true],
                                ['fi', 'Finnish', true],
                                ['fr', 'French', true],
                                ['fa', 'Persian', true],
                                ['gl', 'Galician', true],
                                ['hu', 'Hungarian', true],
                                ['is', 'Icelandic', true],
                                ['it', 'Italian', true],
                                ['lt', 'Lithuanian', true],
                                ['nl', 'Dutch', true],
                                ['no', 'Norwegian', true],
                                ['pl', 'Polish', true],
                                ['pt', 'Portuguese', true],
                                ['ro', 'Romanian', true],
                                ['ru', 'Russian', true],
                                ['sk', 'Slovakian', true],
                                ['sl', 'Slovenian', true],
                                ['sv', 'Swedish', true],
                                ['th', 'Thai', true],
                                ['uk', 'Ukrainian', true],
                            ];
                        }
                    });
            }])
    </script>
</head>
<body ng-app="library-of-alexandria">
<div class="main-container container pb-1">
    <div class="row text-center pt-3 pb-3">
        <div class="col d-none d-md-block">
            <img class="img-fluid left-sphinx" src="./images/sphinx.svg" alt="Sphinx logo">
        </div>
        <div class="col">
            <h2 class="display-4 mt-4" style="font-size: 4.1rem;">
                <a class="title-text" ui-sref="home">Library of Alexandria</a>
            </h2>
        </div>
        <div class="col-md-4 mx-auto d-block">
            <img class="img-fluid right-sphinx" src="./images/sphinx.svg" alt="Sphinx logo">
        </div>
    </div>
    <div ui-view></div>
</div>
</body>
</html>
